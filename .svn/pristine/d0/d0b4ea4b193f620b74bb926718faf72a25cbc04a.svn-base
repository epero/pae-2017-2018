var dtUtilisateurs;
var isInit;
var rowSelectorEntreprise;
var rowSelectorResponsable;
var rowSelectorEtudiant;


FrontEnd.onInitPage('pageDashboardTeacher', function() {
	//console.log('onInitPage - pageDashBoardTeacher');
	dtUtilisateurs =  $('#dtUtilisateurs').DataTable({
		
		bAutoWidth : false,
		//info : false,
		//paging:true,
		dom:"<'pull-left'f>t",
		language : {
			"search" : "Rechercher : ",
			"emptyTable": "Pas de données disponibles dans la table",
			"lengthMenu": "Montrer _MENU_ entrées",
			"paginate": {
				"first":      "Premier",
				"last":       "Dernier",
				"next":       "Suivant",
				"previous":   "Précédent"
			}
		},
		select: {
			style: 'single',
		},
		columns : [ 
			{"data" : getNom},
			{"data" : getPrenom},
			{"data" : getType},
			{"data" : getEmail},
			{"data" : getTelephone}
		]
	});
	
	FrontEnd.onDisplayPage('pageDashboardTeacher', function() {
		//console.log('onDisplayPage - pageDashBoardTeacher');
		$('body').removeClass().toggleClass('theme-teal');
		showNavBar();
		//if(myApp.getWhoAmI()!=null)
		//	$('#nbContacts').text('Contacts : ' + myApp.getWhoAmI().nbContacts);
		remplirUtilisateurs();
	    google.charts.load('current', {'packages':['corechart']});
    	google.charts.setOnLoadCallback(drawChartTeacher);
	});
	
	$('#dtUtilisateurs tbody').on( 'click', 'tr', function () {
		  var rowData = dtUtilisateurs.row( this ).data();
		  console.log(rowData);
		  afficherButton(rowData);	  
	});
	
	
	FrontEnd.onLeavePage('pageDashboardTeacher', function() {
		$('#notification').html('');
		 $('#btnsUsersEtResponsables').html('');
	});

	function drawChartTeacher() {
		
		var stats;
		
		config = {
			'data': {
				'action': 'fillChartTeacher'
			},
			'success': function (reponse) {
				stats =reponse;
				
				//console.log(stats);
				//console.log(stats.aucuncontact);
		        var data = google.visualization.arrayToDataTable([
		          ['Task', 'Hours per Day'],
		          ['Aucun Contact', stats.aucuncontact],
		          ['Contacts Initiés', stats.contactinities],
		          ['Contact Accepté', stats.contactacceptes],
		          ['Stage en ordre', stats.contactstageenordre]
		        ]);

		        var options = {
		        		chartArea:{width:'100%',height:'70%'},
		        		legend:{position:'bottom'}
		        };

		        var chart = new google.visualization.PieChart(document.getElementById('piechartTeacher'));

		        chart.draw(data, options);
			}
		}
		myApp.myajax(config);	
    }	
	
	function remplirUtilisateurs() {
		myApp.myajax({
			data : {
				'action' : 'visualiserUsers',
			},
			success : function(data) {
				dtUtilisateurs.clear();
				dtUtilisateurs.rows.add(data).draw();
				if (isInit !== true){
					remplirSelect();
					isInit = true;
				}
			}
		});
	}

	function remplirSelect(){
		dtUtilisateurs.columns([2]).every( function () {
	        var column = this;
	        var select = $('<select><option value="">Tous</option></select>')
	            .appendTo( $('#dtUtilisateurs_filter') )
	            .on( 'change', function () {
	                var val = $.fn.dataTable.util.escapeRegex(
	                    $(this).val()
	                );

	                column
	                    .search( val ? '^'+val+'$' : '', true, false )
	                    .draw();
	            } );

	        column.data().unique().sort().each( function ( d, j ) {
	            select.append( '<option value="'+d+'">'+d+'</option>' )
	        } );
	    } );
	}

	function afficherButton(data){
		if (data.hasOwnProperty('idUtilisateur')) {
			var btn = $('<button id="btnToStudentDashboard" class="btn btn-lg bg-blue-grey waves-effect" type="button">Visualiser le tableau de bord</button>')
				.on( 'click', data, toStudentDashboard) ;
		} else {
			var btn = $('<button id="btnToEntreprise" class="btn btn-lg bg-blue-grey waves-effect" type="button">Visualiser l\'entreprise</button>')
				.on( 'click', data, toEntreprise) ;
		}
		 $('#btnsUsersEtResponsables').html(btn);
	}

	function toStudentDashboard(event){
		// charge la page Tableau de bord de l'étudiant avec l'étudiant sélectionné
		rowSelectorEtudiant = event.data.idUtilisateur;
		FrontEnd.displayPage('pageDashboardStudent');
	}

	function toEntreprise(event){
		// charge la page Entreprise avec l'idEntreprise de la personne de contact sélectionnée
		rowSelectorEntreprise = "#"+event.data.entreprise;
		rowSelectorResponsable = "#"+event.data.idPersonneContact;
		FrontEnd.displayPage('pageEntreprises');
	}

	function getNom(data){
		return data.nom;
	}

	function getPrenom(data){
		return data.prenom;
	}

	function getTelephone(data){
		return data.tel;
	}

	function getEmail(data){
		return data.email;
	}

	function getType(data){
		if (data.hasOwnProperty('idUtilisateur')) return "Etudiant";
		return "Responsable";
	}
});