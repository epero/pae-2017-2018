package util;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.util.HashMap;
import java.util.Properties;

public class AppContext {

  private static HashMap<Class<?>, Object> instances = new HashMap<Class<?>, Object>();

  private static Properties properties;

  @Retention(RetentionPolicy.RUNTIME)
  public @interface dependanceInjection {
  }

  public static void newInstance(Object objet) {
    if (properties == null) {
      System.out.println("Le fichier properties n'a pas encore été chargé");
      return;
    }


    for (Field field : objet.getClass().getDeclaredFields()) {
      if (field.isAnnotationPresent(dependanceInjection.class)) {
        Object ob;
        Class<?> cl;
        try {
          cl = Class.forName(properties.getProperty(field.getType().getCanonicalName()));
        } catch (ClassNotFoundException e1) {
          System.out.println("Classe inéxistante");
          e1.printStackTrace();
          return;
        }

        if (!instances.containsKey(cl)) {

          Constructor constructor;
          try {
            constructor = cl.getDeclaredConstructor();
          } catch (NoSuchMethodException | SecurityException e) {
            System.out.println("Constructeur inéxistant");
            e.printStackTrace();
            return;
          }
          constructor.setAccessible(true);
          try {
            ob = constructor.newInstance();
          } catch (InstantiationException | IllegalAccessException | IllegalArgumentException
              | InvocationTargetException e) {
            System.out.println("Initialisation impossible");
            e.printStackTrace();
            return;
          }
          instances.put(cl, ob);
          // appel récursif
          newInstance(ob);
        }

        field.setAccessible(true);
        try {
          field.set(objet, instances.get(cl));
        } catch (IllegalArgumentException | IllegalAccessException e) {
          e.printStackTrace();
        }
      }
    }
  }


  /*
   * public static Properties loadDevProps() {
   * 
   * Properties props = new Properties(); FileInputStream file = null;
   * 
   * try { file = new FileInputStream("conf/dev.properties"); } catch (FileNotFoundException ex) {
   * ex.printStackTrace(); System.exit(1); }
   * 
   * try { props.load(file); } catch (IOException ex) { ex.printStackTrace(); System.exit(2); }
   * 
   * try { file.close(); } catch (IOException ex) {
   * System.out.println("Erreur de fermeture du fichier properties"); }
   * 
   * return props; }
   * 
   * public static Properties loadProdProps() {
   * 
   * Properties props = new Properties(); FileInputStream file = null;
   * 
   * try { file = new FileInputStream("conf/prod.properties"); } catch (FileNotFoundException ex) {
   * ex.printStackTrace(); System.exit(1); }
   * 
   * try { props.load(file); } catch (IOException ex) { ex.printStackTrace(); System.exit(2); }
   * 
   * try { file.close(); } catch (IOException ex) {
   * System.out.println("Erreur de fermeture du fichier properties"); }
   * 
   * return props; }
   */

  public static void loadProps(String fichier) {

    properties = new Properties();
    FileInputStream file;

    try {
      file = new FileInputStream("conf/" + fichier);
    } catch (FileNotFoundException e) {
      System.out.println("run du fichier par defaut");
      try {
        file = new FileInputStream("conf/dev.properties");
      } catch (FileNotFoundException e1) {
        e1.printStackTrace();
        System.out.println("Fichier properties introuvable");
        return;
      }
    }

    try {
      properties.load(file);
      file.close();
    } catch (IOException e1) {
      e1.printStackTrace();
    }
  }

  public static String getValueProp(String key) {
    if (properties == null) {
      System.out.println("Le fichier properties n'a pas encore été chargé");
      return null;
    }
    Util.checkString(key);
    return properties.getProperty(key);
  }
}

