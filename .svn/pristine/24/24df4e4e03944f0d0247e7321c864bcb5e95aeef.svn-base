var myApp=(function() {
	
	var varWhoAmI= null;

    myajax = function(config) {
        $.extend(config, {
            type: 'POST',
            url: '/',
            statusCode: {
                422: err422,
				401: err401,
				409: err409,
                500: err500
            }
        });
		
		return $.ajax(config);
    }
    
    function getWhoAmI(){
    	return varWhoAmI;
    }
    
    function setWhoAmI(wai){
    	varWhoAmI = wai;
    }
    
    
    function whoAmI(){
		var currentPage;
		if(FrontEnd.currentPage() === null)
			currentPage = null;
		else
			currentPage = FrontEnd.currentPage().attr('id');
		config = {
			'data': {
				'action': 'whoami'
			},
			'success': function(reponse){
				varWhoAmI=reponse;
				console.log(varWhoAmI);
				if(varWhoAmI!==null){
					if(currentPage===null||currentPage==="pageLogin"||currentPage==="pageSignup")
						FrontEnd.displayPage("pageDashboardStudent");
					else
						FrontEnd.displayPage(currentPage);
				}else{
					if(currentPage==="pageSignup")
						FrontEnd.displayPage("pageSignup");
					else
						FrontEnd.displayPage("pageLogin");
				}
			}
		}
			
		return myajax(config);
	}
    
    function err500(message) {
		FrontEnd.displayPage('pageFatalError');
        $('#err500').text(message.responseText);
    }
    
    function err422(message) {
		$('.notification').html('<div class="alert alert-dismissible bg-red text-center "><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+message.responseText+'</div>');
		$('.notification').show();
    }
    
    function err401(message) {
    	if(varWhoAmI==null||varWhoAmI==undefined)
    		FrontEnd.displayPage('pageLogin');
    		
		$('.notification').html('<div class="alert alert-dismissible bg-red text-center "><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+message.responseText+'</div>');
		$('.notification').show();
	}
	
	function err409(message) {
		$('.notification').html('<div class="alert alert-dismissible bg-red text-center "><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+message.responseText+'</div>');
		$('.notification').show();
	}
    
    function form2Json(racine){
    	var o={};
    	
    	racine.find('input[type=text],input[type=date],input[type=password],textarea').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = el.val();
    	});
    	
    	racine.find('input[type=number]').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = parseFloat(el.val());
    	});
    	
    	racine.find('select[multiple]').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = (el.val()===null?[]:el.val());
    	});
    	
    	racine.find('select:not([multiple])').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = (el.val()==null?"":el.val());
    	});
    	
    	racine.find('input[type=checkbox]').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = el.prop('checked');
    	});
    	
    	racine.find('input[type=radio]').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = null;
    	});
    	
    	/*racine.find('input[type=radio]:checked').each(function(i, el) {
    		el=$(el);
    		o[el.attr('name')] = el.val();
    	});*/
    	racine.find("input[type='radio']").each(function(){
    		if($(this).is(":checked"))
        		o[el.attr('name')] = el.val();
		});
    	
    	return JSON.stringify(o);
    }
    
    function json2Form(racine, json){
    	for (var key in json){
    		var value = json[key];
    		var el = racine.find('[name="' + key + '"]');
    		
    		if (el.is('input[type=number],input[type=text],input[type=date],input[type=password],textarea')){
    			el.val(value);
    		} else if (el.is('select[multiple]')) {
    			el.val(value.length === 0 ? null : value);
    		} else if (el.is('select:not([multiple])')) {
    			el.val(value === null ? "" : value);
    		} else if (el.is('input[type=checkbox]')) {
    			el.prop('checked', value);
    		} else if (el.is('input[type=radio]')) {
    			if (value === null) {
    				el.prop('checked', false);
    			} else {
    				el.filter('[value="' + value + '"]').prop('checked', true);
    			}
    		}
    	}
    }
    
    return {
    	err500:err500,
		err401:err401,
		err409:err409,
    	err422:err422,
		myajax:myajax,
		whoAmI:whoAmI,
		getWhoAmI:getWhoAmI,
		setWhoAmI:setWhoAmI,
		json2Form:json2Form,
		form2Json:form2Json
		
	}
})();
