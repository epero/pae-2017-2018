package biz.ucc;

import java.time.LocalDate;
import biz.user.UserBiz;
import biz.user.UserDto;
import dal.dao.UserDao;
import exceptions.BizException;
import util.AppContext.DependanceInjection;
import util.Util;

class UserUccImpl implements UserUcc {

  @DependanceInjection
  private UserDao userDao;



  @Override
  public UserDto seConnecter(String pseudo, String mdp) {

    UserBiz userEnDb = (UserBiz) userDao.getUser(pseudo);


    if (userEnDb != null && userEnDb.verifierMotDePasse(mdp)) {
      return userEnDb;
    }
    return null;
  }


  @Override
  public UserDto seConnecter(UserDto user) throws BizException {
    UserBiz userAverif = (UserBiz) user;
    Util.checkFormatString(userAverif.getPseudo(), userAverif.MAX_CARACTERES_PSEUDO);
    Util.checkFormatString(userAverif.getMdp(), userAverif.MAX_CARACTERES_MDP);


    UserBiz userEnDb = (UserBiz) userDao.getUser(userAverif.getPseudo());

    if (userEnDb != null && userEnDb.verifierMotDePasse(userAverif.getMdp())) {
      return userEnDb;
    }
    // throw new BizException();
    return null;
  }

  @Override
  public UserDto sinscrire(UserDto user) throws BizException {
    // PROBLEME: n envoie qu une exception avec 1 message --> quid du cas ou il y a plusieurs champs
    // non-valides?
    UserBiz userAVerif = (UserBiz) user;
    Util.checkFormatString(user.getPseudo(), userAVerif.MAX_CARACTERES_PSEUDO);
    Util.checkFormatString(user.getMdp(), userAVerif.MAX_CARACTERES_MDP);
    Util.checkFormatString(user.getPrenom(), userAVerif.MAX_CARACTERES_PRENOM);
    Util.checkFormatString(user.getNom(), userAVerif.MAX_CARACTERES_NOM);
    Util.checkFormatEmail(user.getEmail(), userAVerif.MAX_CARACTERES_EMAIL);
    Util.checkFormatTel(user.getTel(), userAVerif.MAX_CARACTERES_TEL);
    Util.checkFormatDate(user.getDateNaissance());
    user.setDateInscription(LocalDate.now());
    user.setAnneeAcademique(Util.LocalDateToYear(user.getDateInscription()));
    user.setMdp(Util.hashpw(user.getMdp()));
    // TODO CHECK SI EMAIL ET PSEUDO NE SONT PAS DEJA DANS TABLE UTILISATEURS

    if (userDao.pseudoUserExiste(user.getPseudo()))
      throw new BizException("ce pseudo existe deja");
    if (userDao.emailUserExiste(user.getEmail()))
      throw new BizException("cet email existe deja");

    return userDao.insertUser(user);
  }
}
