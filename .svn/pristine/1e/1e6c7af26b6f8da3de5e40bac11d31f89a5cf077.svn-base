package biz.ucc;

import java.util.HashMap;
import java.util.List;
import java.util.logging.Logger;
import biz.entreprise.EntrepriseDto;
import dal.dao.EntrepriseDao;
import dal.services.DalServices;
import exceptions.BizException;
import util.AppContext.DependanceInjection;
import util.Util;

public class EntrepriseUccImpl implements EntrepriseUcc {

  @DependanceInjection
  private EntrepriseDao entrepriseDao;

  @DependanceInjection
  private DalServices dalServices;

  @Override
  public List<EntrepriseDto> visualiserEntreprises() {

    List<EntrepriseDto> entrepriseDtos;

    try {
      dalServices.startTransaction();
      entrepriseDtos = entrepriseDao.getAllEntreprises();
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return entrepriseDtos;
  }

  @Override
  public HashMap<EntrepriseDto, Integer> visualiserEntreprisesAsProf(String anneeAcademique) {

    HashMap<EntrepriseDto, Integer> entrepriseDtos;

    try {
      dalServices.startTransaction();
      entrepriseDtos = entrepriseDao.getAllEntreprisesWithNumberOfStudents(anneeAcademique);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return entrepriseDtos;
  }

  @Override
  public EntrepriseDto getEntreprise(int idEntreprise) {

    EntrepriseDto entrepriseDto;

    try {
      dalServices.startTransaction();
      entrepriseDto = entrepriseDao.getEntreprise(idEntreprise);
      if (entrepriseDto == null)
        throw new BizException("L'entreprise n'existe pas");
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return entrepriseDto;
  }

  @Override
  public EntrepriseDto blacklistEntreprise(EntrepriseDto entreprise) {

    EntrepriseDto entrepriseARet;

    try {
      dalServices.startTransaction();
      entrepriseARet = entrepriseDao.blacklistEntreprise(entreprise);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return entrepriseARet;
  }

  @Override
  public EntrepriseDto insertEntreprise(EntrepriseDto entreprise) {
    EntrepriseDto entrepriseARet = null;
    try {
      dalServices.startTransaction();
      if (entrepriseDao.denominationEntrepriseExiste(entreprise.getDenomination())) {
        throw new BizException("Denomination entreprise existe déjà!");
      }
      Util.checkString(entreprise.getAdresse());
      Util.checkString(entreprise.getCodePostal());
      Util.checkString(entreprise.getVille());
      entreprise.setEstBlackListe(false);
      entreprise.setNumVersion(0);
      entrepriseARet = entrepriseDao.insertEntreprise(entreprise);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return entrepriseARet;
  }


}
