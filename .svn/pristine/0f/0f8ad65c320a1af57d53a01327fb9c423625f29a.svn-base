package ihm.servlet;

import java.io.IOException;
import java.util.logging.ConsoleHandler;
import java.util.logging.FileHandler;
import java.util.logging.Handler;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.servlet.ServletHolder;
import org.eclipse.jetty.webapp.WebAppContext;
import exceptions.FatalException;
import util.AppContext;
import util.AppContext.DependanceInjection;
import util.LogFormatter;
import util.Util;

class Main {
  @DependanceInjection
  private AppContext appContext;
  @DependanceInjection
  private DispatcherServlet dispatcherServlet;

  static Logger monLog = Logger.getLogger("stagifyLogger");

  public static void main(String[] args) {

    // Création logger et handler
    monLog.setLevel(Level.ALL);
    monLog.setUseParentHandlers(false);
    ConsoleHandler ch = new ConsoleHandler();
    ch.setLevel(Level.ALL);
    ch.setFormatter(new LogFormatter());
    monLog.addHandler(ch);
    Handler fh;
    try {
      fh = new FileHandler("Logs.txt");
      fh.setFormatter(new LogFormatter());
      monLog.addHandler(fh);
    } catch (SecurityException ex) {
      monLog.severe("Impossible d'associer le FileHandler");
    } catch (IOException ex) {
      monLog.severe("Impossible d'associer le FileHandler");
    }
    monLog.info("Lancement du serveur");

    String properties = null;

    if (args.length > 0) {
      properties = args[0];
    }
    AppContext appContext = new AppContext();
    appContext.loadProps(properties);
    Main main = new Main();
    appContext.recurDepInj(main);
    main.startServer();
  }


  private void startServer() {
    WebAppContext context = new WebAppContext();
    context.setContextPath("/");

    // context.addServlet(new ServletHolder(new DefaultServlet()), "/");
    context.addServlet(new ServletHolder(dispatcherServlet), "/");
    // context.setWelcomeFiles(new String[] {"index.html"});
    context.setResourceBase("www");
    // context.setInitParameter("cacheControl", "no-store, no-cache, must-revalidate");

    Server server = new Server(Integer.parseInt(appContext.getValueProp("port")));
    server.setHandler(context);

    try {
      server.start();
      Logger.getLogger("stagifyLogger").info("Serveur démarré");
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger")
          .severe("Impossible de démarrer le serveur\n\t" + Util.stackTraceToString(ex));
      throw new FatalException();
    }
  }
}
