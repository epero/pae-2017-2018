package biz.ucc;

import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.logging.Logger;
import biz.user.UserBiz;
import biz.user.UserDto;
import dal.dao.UserDao;
import dal.services.DalServices;
import exceptions.BizException;
import util.AppContext.DependanceInjection;
import util.Util;

class UserUccImpl implements UserUcc {

  @DependanceInjection
  private UserDao userDao;

  @DependanceInjection
  private DalServices dalServices;


  /*
   * @Override public UserDto seConnecter(String pseudo, String mdp) { UserBiz userEnDb; try {
   * dalServices.startTransaction(); userEnDb = (UserBiz) userDao.getUser(pseudo); } catch
   * (Exception ex) { dalServices.rollback(); throw ex; } finally { dalServices.commitTransaction();
   * } if (userEnDb != null && userEnDb.verifierMotDePasse(mdp)) { return userEnDb; } return null; }
   */



  @Override
  public UserDto seConnecter(UserDto user) {
    Util.checkObject(user);
    UserBiz userAverif = (UserBiz) user;
    Util.checkFormatString(userAverif.getPseudo(), userAverif.MAX_CARACTERES_PSEUDO,
        "Le format du champ pseudo est incorrect");
    Util.checkFormatString(userAverif.getMdp(), userAverif.MAX_CARACTERES_MDP,
        "Le format du champ mdp est incorrect");

    UserBiz userEnDb;
    try {
      dalServices.startTransaction();
      userEnDb = (UserBiz) userDao.getUser(userAverif.getPseudo());
    } catch (Exception ex) {
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }

    if (userEnDb != null && userEnDb.verifierMotDePasse(userAverif.getMdp())) {
      return userEnDb;
    }
    return null;
  }

  @Override
  public UserDto sinscrire(UserDto user) {
    Util.checkObject(user);

    UserBiz userAVerif = (UserBiz) user;
    Util.checkFormatString(user.getPseudo(), userAVerif.MAX_CARACTERES_PSEUDO,
        "Le format du Pseudo est incorrect");
    Util.checkFormatString(user.getMdp(), userAVerif.MAX_CARACTERES_MDP,
        "Le format du mdp est incorrect");
    Util.checkFormatString(user.getPrenom(), userAVerif.MAX_CARACTERES_PRENOM,
        "Le format du prenom est incorrect");
    Util.checkFormatString(user.getNom(), userAVerif.MAX_CARACTERES_NOM,
        "Le format du nom est incorrect");
    Util.checkFormatString(user.getEmail(), userAVerif.MAX_CARACTERES_EMAIL, userAVerif.REGEX_EMAIL,
        "Le format de l'email est incorrect");
    Util.checkFormatString(user.getTel(), userAVerif.MAX_CARACTERES_TEL, userAVerif.REGEX_TEL,
        "Le format du numero de tel est incorrect");
    Util.checkFormatDate(user.getDateNaissance(), "Le format de la date est incorrect");
    user.setDateInscription(LocalDate.now());
    user.setAnneeAcademique(Util.localDateToYear(user.getDateInscription()));
    user.setMdp(Util.hashpw(user.getMdp()));
    user.setNumVersion(1);

    UserDto userARenv;
    try {
      dalServices.startTransaction();

      if (userDao.pseudoUserExiste(user.getPseudo())) {
        throw new BizException("ce pseudo existe déjà");
      }
      if (userDao.emailUserExiste(user.getEmail())) {
        throw new BizException("cet email existe déjà");
      }
      userARenv = userDao.insertUser(user);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return userARenv;
  }

  public UserDto updateInfoUtilisateur(UserDto user) {

    UserBiz userAVerif = (UserBiz) user;

    Util.checkFormatString(user.getPseudo(), userAVerif.MAX_CARACTERES_PSEUDO,
        "Le format du Pseudo est incorrect");
    if (user.getMdp() != null) {
      Util.checkFormatString(user.getMdp(), userAVerif.MAX_CARACTERES_MDP,
          "Le format du mdp est incorrect");
    }
    Util.checkFormatString(user.getPrenom(), userAVerif.MAX_CARACTERES_PRENOM,
        "Le format du prenom est incorrect");
    Util.checkFormatString(user.getNom(), userAVerif.MAX_CARACTERES_NOM,
        "Le format du nom est incorrect");
    Util.checkFormatString(user.getEmail(), userAVerif.MAX_CARACTERES_EMAIL, userAVerif.REGEX_EMAIL,
        "Le format de l'email est incorrect");
    Util.checkFormatString(user.getTel(), userAVerif.MAX_CARACTERES_TEL, userAVerif.REGEX_TEL,
        "Le format du numero de tel est incorrect");
    Util.checkFormatDate(user.getDateNaissance(), "Le format de la date est incorrect");

    try {
      dalServices.startTransaction();
      userDao.updateUser(user);
      return userDao.getUser(user.getIdUtilisateur());
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
  }

  public UserDto updateMdpUtilisateur(UserDto user, String mdpActuel, String newMotDePasse1,
      String newMotDePasse2) {
    Util.checkObject(user);
    UserBiz userAVerif = (UserBiz) user;

    Util.checkFormatString(newMotDePasse1, userAVerif.MAX_CARACTERES_MDP,
        "Le format du  nouveau mdp est incorrect");
    if (!newMotDePasse1.equals(newMotDePasse2)) {
      throw new BizException("Les mdp ne correspondent pas");
    }

    try {
      dalServices.startTransaction();
      UserDto userDb = userDao.getUser(user.getIdUtilisateur());
      if (userDb == null) {
        throw new BizException("Cet utilisateur n'existe pas");
      }
      if (!Util.checkpw(mdpActuel, userDb.getMdp())) {
        throw new BizException("Mot de passe actuel éronné");
      }
      String newPswdHashed = Util.hashpw(newMotDePasse1);
      user.setMdp(newPswdHashed);
      userDao.updateMdp(user);
      return userDao.getUser(user.getIdUtilisateur());
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
  }

  @Override
  public UserDto trouverUtilisateurById(UserDto user) {
    Util.checkObject(user);
    UserBiz userAverif = (UserBiz) user;

    UserBiz userEnDb;
    try {
      dalServices.startTransaction();
      userEnDb = (UserBiz) userDao.getUser(userAverif.getIdUtilisateur());
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    if (userEnDb != null) {
      return userEnDb;
    }
    return null;
  }

  @Override
  public int trouverNumVersion(int idUtilisateur) {
    Util.checkInteger(idUtilisateur);
    int numVersion;

    try {
      dalServices.startTransaction();
      numVersion = userDao.getNumVersion(idUtilisateur);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return numVersion;
  }

  @Override
  public HashMap<String, Integer> getStudentsStats() {
    HashMap<String, Integer> stats;

    try {
      dalServices.startTransaction();
      stats = userDao.getStudentsStats(Util.localDateToYear(LocalDate.now()));
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return stats;
  }

  @Override
  public HashMap<String, Integer> getStudentStats(UserDto currentUser) {
    Util.checkObject(currentUser);
    HashMap<String, Integer> stats;

    try {
      dalServices.startTransaction();
      stats = userDao.getStudentStats(currentUser);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return stats;
  }

  @Override
  public List<UserDto> visualiserUsersAnneeCourante() {
    List<UserDto> usersDto;
    String anneeAcademique = Util.localDateToYear(LocalDate.now());

    try {
      dalServices.startTransaction();
      usersDto = userDao.getAllUsers(anneeAcademique);
    } catch (Exception ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return usersDto;
  }
}
