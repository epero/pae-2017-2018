package util;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.util.HashMap;
import java.util.Properties;

public class AppContext {

  private static HashMap<Class<?>, Object> instances = new HashMap<Class<?>, Object>();

  private static Properties properties;

  @Retention(RetentionPolicy.RUNTIME)
  public @interface DependanceInjection {
  }

  /**
   * Crée une nouvelle instance de l'objet en paramètre via l'injection dépendance.
   * 
   * @param objet à instancier
   */
  public static void newInstance(Object objet) {
    if (properties == null) {
      System.out.println("Le fichier properties n'a pas encore été chargé");
      return;
    }


    for (Field field : objet.getClass().getDeclaredFields()) {
      if (field.isAnnotationPresent(DependanceInjection.class)) {
        Object ob;
        Class<?> cl;
        try {
          cl = Class.forName(properties.getProperty(field.getType().getCanonicalName()));
        } catch (ClassNotFoundException e1) {
          System.out.println("Classe inéxistante");
          e1.printStackTrace();
          return;
        }

        if (!instances.containsKey(cl)) {

          Constructor constructor;
          try {
            constructor = cl.getDeclaredConstructor();
          } catch (NoSuchMethodException | SecurityException ex) {
            System.out.println("Constructeur inéxistant");
            ex.printStackTrace();
            return;
          }
          constructor.setAccessible(true);
          try {
            ob = constructor.newInstance();
          } catch (InstantiationException | IllegalAccessException | IllegalArgumentException
              | InvocationTargetException ex) {
            System.out.println("Initialisation impossible");
            ex.printStackTrace();
            return;
          }
          instances.put(cl, ob);
          // appel récursif
          newInstance(ob);
        }

        field.setAccessible(true);
        try {
          field.set(objet, instances.get(cl));
        } catch (IllegalArgumentException | IllegalAccessException ex) {
          ex.printStackTrace();
        }
      }
    }
  }

  /**
   * Charge le fichier Properties passé en paramètre.
   * 
   * @param fichier Le fichier où se trouve les Properties
   */
  public static void loadProps(String fichier) {

    properties = new Properties();
    FileInputStream file;

    try {
      file = new FileInputStream("conf/" + fichier);
    } catch (FileNotFoundException ex1) {
      System.out.println("run du fichier par defaut");
      try {
        file = new FileInputStream("conf/dev.properties");
      } catch (FileNotFoundException ex2) {
        ex2.printStackTrace();
        System.out.println("Fichier properties introuvable");
        return;
      }
    }

    try {
      properties.load(file);
      file.close();
    } catch (IOException e1) {
      e1.printStackTrace();
    }
  }


  /**
   * Cherche la clé associée à la chaîne passée en paramètre.
   * 
   * @param key la chaîne représentant la clé
   * @return la clé correspondante dans le fichier Properties
   */
  public static String getValueProp(String key) {
    if (properties == null) {
      System.out.println("Le fichier properties n'a pas encore été chargé");
      return null;
    }
    Util.checkString(key);
    return properties.getProperty(key);
  }
}

