package dal.dao;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.HashMap;
import java.util.List;
import java.util.logging.Logger;
import biz.factory.BizFactory;
import biz.user.UserDto;
import dal.services.DalBackendServices;
import exceptions.FatalException;
import exceptions.OptimisticLockException;
import util.AppContext.DependanceInjection;
import util.DaoUtil;


class UserDaoImpl implements UserDao {

  @DependanceInjection
  private DalBackendServices dalBackendService;

  @DependanceInjection
  private BizFactory factory;

  @Override
  public UserDto getUser(String pseudo) {
    final String query = "SELECT * FROM stagify.utilisateurs WHERE pseudo = ?";
    // PreparedStatement plutot dans les variables globales de la classe?
    // -> Bonne pratique avec PreparedStatement : les créer une seule fois (au démarrage ou au
    // premier usage)
    PreparedStatement preparedStatement;
    UserDto user;
    List<UserDto> users;

    try {
      preparedStatement = dalBackendService.getPreparedStatement(query);
      DaoUtil.setPreparedStatement(preparedStatement, pseudo);
      try (ResultSet resultSet = preparedStatement.executeQuery()) {
        user = (UserDto) factory.getUserVide();
        users = (List<UserDto>) (Object) DaoUtil.setResultSet(user.getClass(), resultSet);
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException(
          "Erreur lors de la récupération de l'utilisateur dans la base de données.");
    }
    if (users == null || users.isEmpty()) {
      return null;
    }
    return users.get(0);
  }

  @Override
  public UserDto getUser(int idUtilisateur) {
    final String query = "SELECT * FROM stagify.utilisateurs WHERE id_utilisateur = ?";

    PreparedStatement preparedStatement;
    UserDto user;
    List<UserDto> users;

    try {
      preparedStatement = dalBackendService.getPreparedStatement(query);
      DaoUtil.setPreparedStatement(preparedStatement, idUtilisateur);
      try (ResultSet resultSet = preparedStatement.executeQuery()) {
        user = (UserDto) factory.getUserVide();
        users = (List<UserDto>) (Object) DaoUtil.setResultSet(user.getClass(), resultSet);
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException(
          "Erreur lors de la récupération de l'utilisateur dans la base de données.");
    }
    if (users == null || users.size() > 1) {
      throw new FatalException("Erreur de programmation");
    }
    if (users.isEmpty()) {
      return null;
    }
    return users.get(0);
  }

  @Override
  public List<UserDto> getAllUsers(String anneeAcademique) {

    String query =
        "SELECT * FROM stagify.utilisateurs u WHERE u.est_admin = false AND u.annee_academique = ? ";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, anneeAcademique);

    List<UserDto> users;

    try (ResultSet rs = ps.executeQuery()) {
      UserDto user = factory.getUserVide();
      users = (List<UserDto>) (Object) DaoUtil.setResultSet(user.getClass(), rs);

    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException(
          "Erreur lors de la récupération des entreprises dans la base de données.");
    }
    return users;
  }

  public UserDto updateUser(UserDto user) {
    String query = "UPDATE stagify.utilisateurs "
        + "SET nom = ?, prenom = ?, date_naissance = ?, tel = ?, email = ?, nb_contacts = ?, etat_plus_avance = ?, mdp=?, num_version = num_version+1 "
        + "WHERE id_utilisateur = ? AND num_version = ?";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    Timestamp dateNaissance = Timestamp.valueOf(user.getDateNaissance().atStartOfDay());
    DaoUtil.setPreparedStatement(ps, user.getNom(), user.getPrenom(), dateNaissance, user.getTel(),
        user.getEmail(), user.getNbContacts(), user.getEtatPlusAvance(), user.getMdp(),
        user.getIdUtilisateur(), user.getNumVersion());
    try {
      int codeRetour = ps.executeUpdate();
      if (codeRetour == 1) {
        user.setNumVersion(user.getNumVersion() + 1);
        return user;
      } else if (codeRetour == 0) {
        throw new OptimisticLockException(
            "L'utilisateur a été modifié depuis le chargement de cette page",
            getUser(user.getIdUtilisateur()));
      } else {
        throw new FatalException("Erreur de programmation");
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de l'accès DB updateUser()");
    }
  }

  @Override
  public boolean pseudoUserExiste(String pseudo) {
    String query = "SELECT pseudo FROM stagify.utilisateurs WHERE pseudo = ?";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, pseudo);
    try (ResultSet rs = ps.executeQuery()) {
      if (rs.next()) {
        return true;
      } else {
        return false;
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur acces Db");
    }
  }

  @Override
  public boolean emailUserExiste(String email) {
    String query = "SELECT email FROM stagify.utilisateurs WHERE email = ?";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, email);
    try (ResultSet resultSet = ps.executeQuery()) {
      if (resultSet.next()) {
        return true;
      } else {
        return false;
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur acces Db");
    }
  }

  @Override
  public UserDto insertUser(UserDto user) {
    String query = "INSERT INTO stagify.utilisateurs"
        + "(pseudo, mdp, nom, prenom, date_naissance, tel, email, date_inscription, annee_academique, est_admin, nb_contacts, etat_plus_avance, num_version)"
        + "VALUES (?,?,?,?,?,?,?,?,?,?,?, ?, ?)";
    PreparedStatement ps = dalBackendService.getPreparedStatementForInsert(query);// ? PS
    Timestamp dateNaissance = Timestamp.valueOf(user.getDateNaissance().atStartOfDay());
    Timestamp dateInscription = Timestamp.valueOf(user.getDateInscription().atStartOfDay());

    DaoUtil.setPreparedStatement(ps, user.getPseudo(), user.getMdp(), user.getNom(),
        user.getPrenom(), dateNaissance, user.getTel(), user.getEmail(), dateInscription,
        user.getAnneeAcademique(), user.getEstAdmin(), user.getNbContacts(),
        user.getEtatPlusAvance(), user.getNumVersion());
    try {
      int codeRetour = ps.executeUpdate();
      if (codeRetour == 1) {
        try (ResultSet generatedKeys = ps.getGeneratedKeys()) {
          if (generatedKeys.next()) {
            // System.out.println(generatedKeys);
            user.setIdUtilisateur((generatedKeys.getInt(1)));
          }
        }
        return user;
      } else {
        throw new FatalException("Erreur de programmation");
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de l'accès DB");
    }
  }



  @Override
  public UserDto updateNbrContEtatPlusAvance(UserDto user) {
    String query =
        "UPDATE stagify.utilisateurs SET nb_contacts = ?, etat_plus_avance = ?, num_version = num_version+1 WHERE id_utilisateur = ? AND num_version = ?";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, user.getNbContacts(), user.getEtatPlusAvance(),
        user.getIdUtilisateur(), user.getNumVersion());

    try {
      int codeRetour = ps.executeUpdate();
      if (codeRetour == 1) {
        user.setNumVersion(user.getNumVersion() + 1);
        return user;
      } else if (codeRetour == 0) {
        throw new OptimisticLockException(
            "L'utilisateur a été modifié depuis le chargement de cette page",
            getUser(user.getIdUtilisateur()));
      } else {
        throw new FatalException("Erreur de programmation");
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de l'accès DB");
    }
  }

  @Override
  public UserDto updateEtatPlusAvance(UserDto user) {
    String query =
        "UPDATE stagify.utilisateurs SET etat_plus_avance = ?, num_version = num_version+1 WHERE id_utilisateur = ?  AND num_version = ?";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, user.getEtatPlusAvance(), user.getIdUtilisateur(),
        user.getNumVersion());

    try {
      int codeRetour = ps.executeUpdate();
      if (codeRetour == 1) {
        user.setNumVersion(user.getNumVersion() + 1);
        return user;
      } else if (codeRetour == 0) {
        throw new OptimisticLockException(
            "L'utilisateur a été modifié depuis le chargement de cette page",
            getUser(user.getIdUtilisateur()));
      } else {
        throw new FatalException("Erreur de programmation");
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de l'accès DB");
    }
  }

  public UserDto updateMdp(UserDto utilisateur) {
    String query =
        "UPDATE stagify.utilisateurs SET mdp = ?, num_version = num_version+1 WHERE id_utilisateur = ?  AND num_version = ?";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, utilisateur.getMdp(), utilisateur.getIdUtilisateur(),
        utilisateur.getNumVersion());

    try {
      int codeRetour = ps.executeUpdate();
      if (codeRetour == 1) {
        utilisateur.setNumVersion(utilisateur.getNumVersion() + 1);
        return utilisateur;
      } else if (codeRetour == 0) {
        throw new OptimisticLockException(
            "L'utilisateur a été modifié depuis le chargement de cette page",
            getUser(utilisateur.getIdUtilisateur()));
      } else {
        throw new FatalException("Erreur de programmation");
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de l'accès DB");
    }
  }

  @Override
  public int getNumVersion(int idUtilisateur) {
    String query = "SELECT num_version FROM stagify.utilisateurs WHERE id_utilisateur = ? ";
    PreparedStatement ps = dalBackendService.getPreparedStatement(query);
    DaoUtil.setPreparedStatement(ps, idUtilisateur);
    try (ResultSet rs = ps.executeQuery()) {
      rs.next();
      return rs.getInt("num_version");
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur acces Db");
    }
  }

  @Override
  public HashMap<String, Integer> getStudentsStats(String anneeAcademique) {
    String query = "select count(*) total, "
        + "sum(case when nb_contacts = 0 then 1 else 0 end) aucunContact, "
        + "sum(case when nb_contacts != 0 and 0=(select count(*) from stagify.contacts where utilisateur=id_utilisateur and (etat=3 or etat=4)) then 1 else 0 end) contactInities, "
        + "sum(case when nb_contacts != 0 and 0=(select count(*) from stagify.contacts where utilisateur=id_utilisateur and etat=4) and 0<(select count(*) from stagify.contacts where utilisateur=id_utilisateur and etat=3) then 1 else 0 end) contactAcceptes, "
        + "sum(case when nb_contacts != 0 and 0<(select count(*) from stagify.contacts where utilisateur=id_utilisateur and etat=4) then 1 else 0 end) contactStageEnOrdre "
        + "from stagify.utilisateurs where est_admin = 'f' and annee_academique = ?";

    PreparedStatement preparedStatement;
    HashMap<String, Integer> stats;
    try {
      preparedStatement = dalBackendService.getPreparedStatement(query);
      DaoUtil.setPreparedStatement(preparedStatement, anneeAcademique);
      try (ResultSet resultSet = preparedStatement.executeQuery()) {
        if (resultSet.next()) {
          stats = new HashMap();
          stats.put(resultSet.getMetaData().getColumnName(2), resultSet.getInt(2));
          stats.put(resultSet.getMetaData().getColumnName(3), resultSet.getInt(3));
          stats.put(resultSet.getMetaData().getColumnName(4), resultSet.getInt(4));
          stats.put(resultSet.getMetaData().getColumnName(5), resultSet.getInt(5));
        } else {
          throw new FatalException("Erreur de programmation");
        }
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de la récupération des stats dans la base de données.");
    }
    if (stats == null || stats.isEmpty()) {
      throw new FatalException("Erreur de programmation");
    }
    return stats;
  }

  @Override
  public HashMap<String, Integer> getStudentStats(int idUser) {
    // TODO A MODIFIER
    String query =
        "select count(*) total, " + "sum(case when etat=0 then 1 else 0 end) contactsInities, "
            + "sum(case when etat=2 then 1 else 0 end) contactsPris, "
            + "sum(case when etat=1 then 1 else 0 end) contactsRefuses "
            + "from stagify.contacts where utilisateur = ?";

    PreparedStatement preparedStatement;
    HashMap<String, Integer> stats;
    try {
      preparedStatement = dalBackendService.getPreparedStatement(query);
      DaoUtil.setPreparedStatement(preparedStatement, idUser);
      try (ResultSet resultSet = preparedStatement.executeQuery()) {
        if (resultSet.next()) {
          stats = new HashMap();
          stats.put(resultSet.getMetaData().getColumnName(2), resultSet.getInt(2));
          stats.put(resultSet.getMetaData().getColumnName(3), resultSet.getInt(3));
          stats.put(resultSet.getMetaData().getColumnName(4), resultSet.getInt(4));
        } else {
          throw new FatalException("Erreur de programmation");
        }
      }
    } catch (SQLException ex) {
      Logger.getLogger("stagifyLogger").fine(ex.getMessage());
      throw new FatalException("Erreur lors de la récupération des stats dans la base de données.");
    }
    if (stats == null || stats.isEmpty()) {
      throw new FatalException("Erreur de progrmmation");
    }
    return stats;
  }


}
