package biz.ucc;

import java.time.LocalDate;
import java.util.List;
import biz.contact.ContactBiz;
import biz.contact.ContactDto;
import biz.entreprise.EntrepriseDto;
import biz.user.UserDto;
import dal.dao.ContactDao;
import dal.dao.EntrepriseDao;
import dal.dao.PersonneContactDao;
import dal.dao.UserDao;
import dal.services.DalServices;
import exceptions.BizException;
import util.AppContext.DependanceInjection;
import util.Util;

public class ContactUccImpl implements ContactUcc {
  @DependanceInjection
  private ContactDao contactDao;
  @DependanceInjection
  private PersonneContactDao personneContactDao;
  @DependanceInjection
  private UserDao userDao;
  @DependanceInjection
  private EntrepriseDao entrepriseDao;
  @DependanceInjection
  private DalServices dalServices;


  @Override
  public List<ContactDto> listerContactUtilisateur(UserDto utilisateur) {
    Util.checkObject(utilisateur);
    List<ContactDto> listeContactDto;

    try {
      dalServices.startTransaction();
      UserDto userAVerifier = userDao.getUser(utilisateur.getIdUtilisateur());
      listeContactDto = contactDao.listerContactUtilisateur(userAVerifier);
    } catch (Exception ex) {
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return listeContactDto;
  }

  @Override
  public ContactDto creerContactUtilisateur(ContactDto contact) {
    Util.checkObject(contact);
    Util.checkObject(contact.getEntrepriseDto());
    Util.checkObject(contact.getUtilisateurDto());
    ContactBiz contactAVerif = (ContactBiz) contact;

    contact.setEtat(Util.Etat.INITIE.toString());
    contact.setAnneeAcademique(Util.localDateToYear(LocalDate.now()));
    contact.setNumVersion(1);

    ContactDto contactARenv;
    try {
      dalServices.startTransaction();
      UserDto userAVerifier = userDao.getUser(contact.getUtilisateurDto().getIdUtilisateur());
      EntrepriseDto entrepriseAVerifier =
          entrepriseDao.getEntreprise(contact.getEntrepriseDto().getIdEntreprise());
      if (userAVerifier == null || entrepriseAVerifier == null) {
        throw new BizException("L'entreprise ou l'utilisateur n'existe pas");
      }
      int idUtilisateur = userAVerifier.getIdUtilisateur();
      int idEntreprise = entrepriseAVerifier.getIdEntreprise();

      if (contactDao.contactEntrepriseExiste(idUtilisateur, idEntreprise)) {
        throw new BizException("Vous avez déjà initié un contact avec cette entreprise");
      }

      if (contact.getPersonneContactDto() != null) {
        if (!personneContactDao.personneDeContactAppartientEntreprise(
            contact.getPersonneContactDto().getIdPersonneContact(), idEntreprise)) {
          throw new BizException("Cette personne de contact n'appartient pas à cette entreprise");
        }
        contactARenv = contactDao.insertContactUtilisateurAvecPersonneContact(contactAVerif);
      } else {
        contactARenv = contactDao.insertContactUtilisateurSansPersonneContact(contactAVerif);
      }
      userDao.incrementNumberOfContacts(userAVerifier);
      contactARenv.setUtilisateurDto(userDao.getUser(userAVerifier.getIdUtilisateur()));
    } catch (Exception ex) {
      dalServices.rollback();
      throw ex;
    } finally {
      dalServices.commitTransaction();
    }
    return contactARenv;
  }

  @Override
  public ContactDto updateEtatContact(int idContact, String etat) {
    Util.checkString(etat);
    boolean updateEstValide = false;
    try {
      dalServices.startTransaction();
      // checks pour voir si on peut faire l'update(si le contact courant est refuse ou stage en
      // ordre on ne peut plus changer d'etat)
      ContactDto contactInitial = contactDao.getContact(idContact);
      String etatInitial = contactInitial.getEtat();
      if (etatInitial.equals(Util.Etat.INITIE.toString())) {
        if (etat.equals(Util.Etat.PRIS.toString()) || etat.equals(Util.Etat.ACCEPTE.toString())
            || etat.equals(Util.Etat.REFUSE.toString())) {
          updateEstValide = true;
        }
      } else if (etatInitial.equals(Util.Etat.PRIS.toString())) {
        if (etat.equals(Util.Etat.ACCEPTE.toString()) || etat.equals(Util.Etat.REFUSE.toString())) {
          updateEstValide = true;
        }
      } else if (etatInitial.equals(Util.Etat.ACCEPTE.toString())) {
        if (etat.equals(Util.Etat.STAGE_EN_ORDRE.toString())) {
          updateEstValide = true;
        }
      }
      // check si il existe pas deja un autre contact à l'état accepte ou stage en ordre
      if (contactDao.existeContactAvecEtat(contactInitial.getUtilisateur(),
          Util.Etat.ACCEPTE.toString())
          || contactDao.existeContactAvecEtat(contactInitial.getUtilisateur(),
              Util.Etat.STAGE_EN_ORDRE.toString())) {
        updateEstValide = false;
      }
      if (updateEstValide
          && contactDao.updateEtatContact(idContact, etat, contactInitial.getNumVersion())) {
        ContactDto updatedContact = contactDao.getContact(idContact);
        return updatedContact;
      } else {
        return null;
      }
    } catch (Exception e) {
      dalServices.rollback();
      throw e;
    } finally {
      dalServices.commitTransaction();
    }
  }

  @Override
  public boolean existeContactAccepte(int idUser) {
    try {
      dalServices.startTransaction();
      return contactDao.existeContactAvecEtat(idUser, Util.Etat.ACCEPTE.toString());
    } catch (Exception e) {
      dalServices.rollback();
      throw e;
    } finally {
      dalServices.commitTransaction();
    }
  }

  // @Override
  // public List<ContactDto> listerContactUtilisateur(int idUtilisateur) {
  // return contactDao.listerContactUtilisateur(idUtilisateur);
  // }


}
