let user;

FrontEnd.onInitPage('pageDonneesPerso', function () {
	
	$('#btn-modif-mdp').on('click', function () {
	    $('#div-btn-modif-mdp').css('display', 'none');
	    $('#inputs-modif-mdp').css('display', 'block');
	});

	$('#btn-donnees-perso-cancel').on('click', function () {

	    if (myApp.getWhoAmI().estAdmin === false) {

	        FrontEnd.displayPage('pageDashboardStudent');
	    }
	    else {
	        FrontEnd.displayPage('pageDashboardTeacher');
	    }
	});

	$('#btn-mdp-cancel').on('click', function () {
	    $('#div-btn-modif-mdp').css('display', 'block');
	    $('#inputs-modif-mdp').css('display', 'none');
	    $('#form-modif-donnees-perso')[0].reset();
	});

	$('#btn-mdp-submit').on('click', function () {
	    
	    if ($('#form-modif-donnees-perso #mdpActuel').val().length !== 0 && $('#form-modif-donnees-perso #nouveauMdp1').val().length !== 0
	        && $('#form-modif-donnees-perso #nouveauMdp2').val().length !== 0) {

	        var isvalid = $('#form-modif-donnees-perso').valid();
	        if (isvalid) {
	            
	            config = {
	                'data': {
	                    'action': 'setMdpUser',
	                    'user': JSON.stringify(user),
	                    'mdpActuel': $('#form-modif-donnees-perso #mdpActuel').val(),
	                    'nouveauMdp1': $('#form-modif-donnees-perso #nouveauMdp1').val(),
	                    'nouveauMdp2': $('#form-modif-donnees-perso #nouveauMdp2').val()
	                },
	                'success': function (reponse) {
	                    if (reponse != 0) {
	                        $('#notification-form-infos-perso').html('<div class="alert alert-dismissible bg-green text-center"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Votre mot de passe a été modifié</div>');
	                    } else {
	                        $('#notification-form-infos-perso').html('<div class="alert alert-dismissible bg-red text-center"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Votre mot de passe n\'a pas été modifié</div>');
	                    }
	                }
	            }
	            myApp.myajax(config);
	        }
	    }
	});

	$('#btn-donnees-perso-submit').on('click', function () {

	    //vérification si pseudo non changé
	    /*if ($('#form-modif-donnees-perso #pseudo').val() !== myApp.getWhoAmI().pseudo) {
	        $('#notification-form-infos-perso').html('<div class="alert alert-dismissible bg-red text-center"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Vous ne pouvez pas modifier votre pseudo</div>');
	    }

	    //Verification si modification
	    else*/ if ($('#form-modif-donnees-perso #nom').val() === myApp.getWhoAmI().nom && $('#form-modif-donnees-perso #prenom').val() === myApp.getWhoAmI().prenom 
	            && $('#form-modif-donnees-perso #dateNaissance').val() === myApp.getWhoAmI().nom.dateNaissance && $('#form-modif-donnees-perso #email').val() === myApp.getWhoAmI().nom.email 
	            && $('#form-modif-donnees-perso #tel').val() === myApp.getWhoAmI().nom.tel) {

	        $('#notification-form-infos-perso').html('<div class="alert alert-dismissible bg-orange text-center"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Vous n\'avez fait aucune modification</div>');
	    }
	    else {

	        var isvalid = $('#form-modif-donnees-perso').valid();
	        if (isvalid) {

	            //On remplace les valeurs dans le formulaire
	            /*user.nom = $('#form-modif-donnees-perso #nom').val();
	            user.prenom = $('#form-modif-donnees-perso #prenom').val();
	            user.dateNaissance = $('#form-modif-donnees-perso #dateNaissance').val();
	            user.email = $('#form-modif-donnees-perso #email').val();
	            user.tel = $('#form-modif-donnees-perso #tel').val();
	            console.log("test");*/
	        	var userModif = JSON.parse(myApp.form2Json($("#form-modif-donnees-perso")));
	        	userModif['numVersion'] = myApp.getWhoAmI().numVersion;
	        	userModif = JSON.stringify(userModif);
	            config = {
	                'data': {
	                    'action': 'setInfosPersoUser',
	                    'user': userModif
	                    //'user': JSON.stringify(user),
	                },
	                'success': function (reponse) {
	                    if (reponse != null) {
	                    	myApp.setWhoAmI(reponse);
	                    	updateNavBar();
	                    	$('#notification-form-infos-perso').html('<div class="alert alert-dismissible bg-green text-center"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>Vos informations ont été modifées</div>');
	                    }
	                },
	                'error': function(e) {
	                	var reponse = JSON.parse(e.responseText);
	                	myApp.setWhoAmI(reponse.objetDb);
	                	updateNavBar();
	                    date = new Date(reponse.objetDb.dateNaissance.monthValue + " " + reponse.objetDb.dateNaissance.dayOfMonth + " " + reponse.objetDb.dateNaissance.year);
	                    reponse.objetDb.dateNaissance = dateFormatee(date);
	                	myApp.json2Form($("#form-modif-donnees-perso"), reponse.objetDb);
	                }
	            }
	            myApp.myajax(config);
	        }
	    }
	});


	FrontEnd.onDisplayPage('pageDonneesPerso', function () {

	    $('body').removeClass().toggleClass('theme-teal');
	    showNavBar();

	    // Affichage par défaut du formulaire
	    $('#div-btn-modif-mdp').css('display', 'block');
	    $('#inputs-modif-mdp').css('display', 'none');
	    $("#form-modif-donnees-perso").validate().resetForm();
	    $('.form-line').removeClass('error focused');

	    config = {
	        'data': {
	            'action': 'getInfosPersoUser'
	            //'user': user
	        },
	        'success': function (reponse) {
	            date = new Date(reponse.dateNaissance.monthValue + " " + reponse.dateNaissance.dayOfMonth + " " + reponse.dateNaissance.year);
	            reponse.dateNaissance = dateFormatee(date);
	            myApp.setWhoAmI(reponse);
	            myApp.json2Form($('#form-modif-donnees-perso'), reponse);
	        }
	    }
	    myApp.myajax(config);
	});
	
	FrontEnd.onLeavePage('pageDonneesPerso', function(){
	    $('#form-modif-donnees-perso')[0].reset();
	    $('.notification').text('');
	    user = undefined;
	});
});

function dateFormatee(d) {
    let month = String(d.getMonth() + 1);
    let day = String(d.getDate());
    const year = String(d.getFullYear());

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return `${day}/${month}/${year}`;
}